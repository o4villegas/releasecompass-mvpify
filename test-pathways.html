<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReleaseCompass Pathway Testing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #42a5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .success {
            border-left: 4px solid #4caf50;
        }
        .error {
            border-left: 4px solid #f44336;
        }
        .warning {
            border-left: 4px solid #ff9800;
        }
        iframe {
            width: 100%;
            height: 700px;
            border: 2px solid #333;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ReleaseCompass MVP - Pathway Analysis Testing</h1>

    <div class="test-section">
        <h2>Live Application Embed</h2>
        <iframe id="appFrame" src="https://releasecompass-mvpify.lando555.workers.dev"></iframe>
    </div>

    <div class="test-section">
        <h2>Pathway Testing Controls</h2>
        <button onclick="testPageLoad()">Test Page Load</button>
        <button onclick="testCanvasRendering()">Test Canvas Rendering</button>
        <button onclick="testWebSocketConnection()">Test WebSocket Connection</button>
        <button onclick="testConsoleErrors()">Check Console Errors</button>
        <button onclick="testUIElements()">Test UI Elements</button>
        <button onclick="testMilestoneInteraction()">Test Milestone Interaction</button>
        <button onclick="runFullPathwayAnalysis()">Run Full Pathway Analysis</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const appFrame = document.getElementById('appFrame');

        function addResult(text, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = `[${new Date().toISOString()}] ${text}`;
            resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild);
        }

        function testPageLoad() {
            addResult('Testing page load status...', 'info');

            try {
                // Check if iframe is loaded
                if (appFrame.contentDocument) {
                    const rootElement = appFrame.contentDocument.getElementById('root');
                    if (rootElement) {
                        const innerHTML = rootElement.innerHTML;
                        if (innerHTML.includes('Loading...')) {
                            addResult('⚠️ Application stuck in loading state', 'warning');
                        } else if (innerHTML.includes('timeline-app')) {
                            addResult('✓ Application loaded successfully', 'success');
                        } else {
                            addResult('✗ Unknown application state: ' + innerHTML.substring(0, 100), 'error');
                        }
                    } else {
                        addResult('✗ Root element not found', 'error');
                    }
                } else {
                    addResult('✗ Cannot access iframe content (CORS restriction)', 'error');
                }
            } catch (e) {
                addResult('✗ Cross-origin access blocked: ' + e.message, 'error');
            }
        }

        function testCanvasRendering() {
            addResult('Testing canvas rendering...', 'info');

            try {
                if (appFrame.contentDocument) {
                    const canvases = appFrame.contentDocument.getElementsByTagName('canvas');
                    if (canvases.length > 0) {
                        addResult(`✓ Found ${canvases.length} canvas element(s)`, 'success');
                        for (let i = 0; i < canvases.length; i++) {
                            const canvas = canvases[i];
                            addResult(`  Canvas ${i+1}: ${canvas.width}x${canvas.height} pixels`, 'success');
                        }
                    } else {
                        addResult('✗ No canvas elements found - 3D timeline not rendering', 'error');
                    }
                } else {
                    addResult('✗ Cannot access iframe content (CORS restriction)', 'error');
                }
            } catch (e) {
                addResult('✗ Cross-origin access blocked: ' + e.message, 'error');
            }
        }

        function testWebSocketConnection() {
            addResult('Testing WebSocket/PartySocket connection...', 'info');

            // Test direct connection to PartySocket
            try {
                const ws = new WebSocket('wss://releasecompass-mvpify.lando555.workers.dev/parties/globe/default');

                ws.onopen = () => {
                    addResult('✓ WebSocket connection established', 'success');
                    ws.close();
                };

                ws.onerror = (error) => {
                    addResult('✗ WebSocket connection failed: ' + error, 'error');
                };

                ws.onclose = (event) => {
                    if (event.code !== 1000) {
                        addResult(`⚠️ WebSocket closed with code ${event.code}: ${event.reason}`, 'warning');
                    }
                };

                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        addResult('✗ WebSocket connection timeout', 'error');
                        ws.close();
                    }
                }, 5000);
            } catch (e) {
                addResult('✗ Failed to create WebSocket: ' + e.message, 'error');
            }
        }

        function testConsoleErrors() {
            addResult('Checking for console errors...', 'info');
            addResult('⚠️ Cannot directly access iframe console due to CORS', 'warning');
            addResult('Please open browser DevTools and check console for errors', 'info');
        }

        function testUIElements() {
            addResult('Testing UI elements...', 'info');

            try {
                if (appFrame.contentDocument) {
                    const elements = {
                        'timeline-header': 'Timeline Header',
                        'timeline-main': 'Main Timeline Container',
                        'timeline-3d': '3D Timeline Canvas Container',
                        'timeline-sidebar': 'Sidebar',
                        'financial-summary': 'Financial Summary',
                        'add-milestone-btn': 'Add Milestone Button'
                    };

                    for (const [className, description] of Object.entries(elements)) {
                        const element = appFrame.contentDocument.querySelector(`.${className}`);
                        if (element) {
                            addResult(`✓ ${description} found`, 'success');
                        } else {
                            addResult(`✗ ${description} not found (class: .${className})`, 'error');
                        }
                    }
                } else {
                    addResult('✗ Cannot access iframe content (CORS restriction)', 'error');
                }
            } catch (e) {
                addResult('✗ Cross-origin access blocked: ' + e.message, 'error');
            }
        }

        function testMilestoneInteraction() {
            addResult('Testing milestone interaction...', 'info');
            addResult('⚠️ Direct interaction testing blocked by CORS', 'warning');
            addResult('Manual testing required:', 'info');
            addResult('  1. Click "Add Milestone" button', 'info');
            addResult('  2. Double-click on timeline to create milestone', 'info');
            addResult('  3. Click milestone to edit', 'info');
            addResult('  4. Drag milestone to reposition', 'info');
        }

        async function runFullPathwayAnalysis() {
            addResult('=== Starting Full Pathway Analysis ===', 'info');

            // Run all tests sequentially
            testPageLoad();
            await new Promise(resolve => setTimeout(resolve, 1000));

            testCanvasRendering();
            await new Promise(resolve => setTimeout(resolve, 1000));

            testWebSocketConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));

            testUIElements();
            await new Promise(resolve => setTimeout(resolve, 1000));

            testMilestoneInteraction();

            addResult('=== Pathway Analysis Complete ===', 'info');
            addResult('Please check browser DevTools console for additional errors', 'warning');
        }

        // Auto-run analysis on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('Page loaded. Starting automated testing...', 'info');
                runFullPathwayAnalysis();
            }, 2000);
        });
    </script>
</body>
</html>